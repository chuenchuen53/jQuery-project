//@ts-check
/* global $*/

class KeyData {
  static data = Object.freeze({
    0: {
      key: "0",
      code: "Digit0",
      shiftKey: false,
      finger: "rightLittle",
      shiftFinger: "",
      type: "digit",
      keyboardRow: 1,
    },
    1: {
      key: "1",
      code: "Digit1",
      shiftKey: false,
      finger: "leftLittle",
      shiftFinger: "",
      type: "digit",
      keyboardRow: 1,
    },
    2: {
      key: "2",
      code: "Digit2",
      shiftKey: false,
      finger: "leftRing",
      shiftFinger: "",
      type: "digit",
      keyboardRow: 1,
    },
    3: {
      key: "3",
      code: "Digit3",
      shiftKey: false,
      finger: "leftMiddle",
      shiftFinger: "",
      type: "digit",
      keyboardRow: 1,
    },
    4: {
      key: "4",
      code: "Digit4",
      shiftKey: false,
      finger: "leftIndex",
      shiftFinger: "",
      type: "digit",
      keyboardRow: 1,
    },
    5: {
      key: "5",
      code: "Digit5",
      shiftKey: false,
      finger: "leftIndex",
      shiftFinger: "",
      type: "digit",
      keyboardRow: 1,
    },
    6: {
      key: "6",
      code: "Digit6",
      shiftKey: false,
      finger: "rightIndex",
      shiftFinger: "",
      type: "digit",
      keyboardRow: 1,
    },
    7: {
      key: "7",
      code: "Digit7",
      shiftKey: false,
      finger: "rightIndex",
      shiftFinger: "",
      type: "digit",
      keyboardRow: 1,
    },
    8: {
      key: "8",
      code: "Digit8",
      shiftKey: false,
      finger: "rightMiddle",
      shiftFinger: "",
      type: "digit",
      keyboardRow: 1,
    },
    9: {
      key: "9",
      code: "Digit9",
      shiftKey: false,
      finger: "rightRing",
      shiftFinger: "",
      type: "digit",
      keyboardRow: 1,
    },
    q: {
      key: "q",
      code: "KeyQ",
      shiftKey: false,
      finger: "leftLittle",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 2,
    },
    a: {
      key: "a",
      code: "KeyA",
      shiftKey: false,
      finger: "leftLittle",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 3,
    },
    z: {
      key: "z",
      code: "KeyZ",
      shiftKey: false,
      finger: "leftLittle",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 4,
    },
    w: {
      key: "w",
      code: "KeyW",
      shiftKey: false,
      finger: "leftRing",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 2,
    },
    s: {
      key: "s",
      code: "KeyS",
      shiftKey: false,
      finger: "leftRing",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 3,
    },
    x: {
      key: "x",
      code: "KeyX",
      shiftKey: false,
      finger: "leftRing",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 4,
    },
    e: {
      key: "e",
      code: "KeyE",
      shiftKey: false,
      finger: "leftMiddle",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 2,
    },
    d: {
      key: "d",
      code: "KeyD",
      shiftKey: false,
      finger: "leftMiddle",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 3,
    },
    c: {
      key: "c",
      code: "KeyC",
      shiftKey: false,
      finger: "leftMiddle",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 4,
    },
    r: {
      key: "r",
      code: "KeyR",
      shiftKey: false,
      finger: "leftIndex",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 2,
    },
    f: {
      key: "f",
      code: "KeyF",
      shiftKey: false,
      finger: "leftIndex",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 3,
    },
    v: {
      key: "v",
      code: "KeyV",
      shiftKey: false,
      finger: "leftIndex",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 4,
    },
    t: {
      key: "t",
      code: "KeyT",
      shiftKey: false,
      finger: "leftIndex",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 2,
    },
    g: {
      key: "g",
      code: "KeyG",
      shiftKey: false,
      finger: "leftIndex",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 3,
    },
    b: {
      key: "b",
      code: "KeyB",
      shiftKey: false,
      finger: "leftIndex",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 4,
    },
    y: {
      key: "y",
      code: "KeyY",
      shiftKey: false,
      finger: "rightIndex",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 2,
    },
    h: {
      key: "h",
      code: "KeyH",
      shiftKey: false,
      finger: "rightIndex",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 3,
    },
    n: {
      key: "n",
      code: "KeyN",
      shiftKey: false,
      finger: "rightIndex",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 4,
    },
    u: {
      key: "u",
      code: "KeyU",
      shiftKey: false,
      finger: "rightIndex",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 2,
    },
    j: {
      key: "j",
      code: "KeyJ",
      shiftKey: false,
      finger: "rightIndex",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 3,
    },
    m: {
      key: "m",
      code: "KeyM",
      shiftKey: false,
      finger: "rightIndex",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 4,
    },
    i: {
      key: "i",
      code: "KeyI",
      shiftKey: false,
      finger: "rightMiddle",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 2,
    },
    k: {
      key: "k",
      code: "KeyK",
      shiftKey: false,
      finger: "rightMiddle",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 3,
    },
    ",": {
      key: ",",
      code: "Comma",
      shiftKey: false,
      finger: "rightMiddle",
      shiftFinger: "",
      type: "basic-symbol",
      keyboardRow: 4,
    },
    o: {
      key: "o",
      code: "KeyO",
      shiftKey: false,
      finger: "rightRing",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 2,
    },
    l: {
      key: "l",
      code: "KeyL",
      shiftKey: false,
      finger: "rightRing",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 3,
    },
    ".": {
      key: ".",
      code: "Period",
      shiftKey: false,
      finger: "rightRing",
      shiftFinger: "",
      type: "basic-symbol",
      keyboardRow: 4,
    },
    p: {
      key: "p",
      code: "KeyP",
      shiftKey: false,
      finger: "rightLittle",
      shiftFinger: "",
      type: "alphabet",
      keyboardRow: 2,
    },
    ";": {
      key: ";",
      code: "Semicolon",
      shiftKey: false,
      finger: "rightLittle",
      shiftFinger: "",
      type: "basic-symbol",
      keyboardRow: 3,
    },
    "/": {
      key: "/",
      code: "Slash",
      shiftKey: false,
      finger: "rightLittle",
      shiftFinger: "",
      type: "basic-symbol",
      keyboardRow: 4,
    },
    "!": {
      key: "!",
      code: "Digit1",
      shiftKey: true,
      finger: "leftLittle",
      shiftFinger: "right",
      type: "digit-symbol",
      keyboardRow: 1,
    },
    Q: {
      key: "Q",
      code: "KeyQ",
      shiftKey: true,
      finger: "leftLittle",
      shiftFinger: "right",
      type: "ALPHABET",
      keyboardRow: 2,
    },
    A: {
      key: "A",
      code: "KeyA",
      shiftKey: true,
      finger: "leftLittle",
      shiftFinger: "right",
      type: "ALPHABET",
      keyboardRow: 3,
    },
    Z: {
      key: "Z",
      code: "KeyZ",
      shiftKey: true,
      finger: "leftLittle",
      shiftFinger: "right",
      type: "ALPHABET",
      keyboardRow: 4,
    },
    "@": {
      key: "@",
      code: "Digit2",
      shiftKey: true,
      finger: "leftRing",
      shiftFinger: "right",
      type: "digit-symbol",
      keyboardRow: 1,
    },
    W: {
      key: "W",
      code: "KeyW",
      shiftKey: true,
      finger: "leftRing",
      shiftFinger: "right",
      type: "ALPHABET",
      keyboardRow: 2,
    },
    S: {
      key: "S",
      code: "KeyS",
      shiftKey: true,
      finger: "leftRing",
      shiftFinger: "right",
      type: "ALPHABET",
      keyboardRow: 3,
    },
    X: {
      key: "X",
      code: "KeyX",
      shiftKey: true,
      finger: "leftRing",
      shiftFinger: "right",
      type: "ALPHABET",
      keyboardRow: 4,
    },
    "#": {
      key: "#",
      code: "Digit3",
      shiftKey: true,
      finger: "leftMiddle",
      shiftFinger: "right",
      type: "digit-symbol",
      keyboardRow: 1,
    },
    E: {
      key: "E",
      code: "KeyE",
      shiftKey: true,
      finger: "leftMiddle",
      shiftFinger: "right",
      type: "ALPHABET",
      keyboardRow: 2,
    },
    D: {
      key: "D",
      code: "KeyD",
      shiftKey: true,
      finger: "leftMiddle",
      shiftFinger: "right",
      type: "ALPHABET",
      keyboardRow: 3,
    },
    C: {
      key: "C",
      code: "KeyC",
      shiftKey: true,
      finger: "leftMiddle",
      shiftFinger: "right",
      type: "ALPHABET",
      keyboardRow: 4,
    },
    $: {
      key: "$",
      code: "Digit4",
      shiftKey: true,
      finger: "leftIndex",
      shiftFinger: "right",
      type: "digit-symbol",
      keyboardRow: 1,
    },
    R: {
      key: "R",
      code: "KeyR",
      shiftKey: true,
      finger: "leftIndex",
      shiftFinger: "right",
      type: "ALPHABET",
      keyboardRow: 2,
    },
    F: {
      key: "F",
      code: "KeyF",
      shiftKey: true,
      finger: "leftIndex",
      shiftFinger: "right",
      type: "ALPHABET",
      keyboardRow: 3,
    },
    V: {
      key: "V",
      code: "KeyV",
      shiftKey: true,
      finger: "leftIndex",
      shiftFinger: "right",
      type: "ALPHABET",
      keyboardRow: 4,
    },
    "%": {
      key: "%",
      code: "Digit5",
      shiftKey: true,
      finger: "leftIndex",
      shiftFinger: "right",
      type: "digit-symbol",
      keyboardRow: 1,
    },
    T: {
      key: "T",
      code: "KeyT",
      shiftKey: true,
      finger: "leftIndex",
      shiftFinger: "right",
      type: "ALPHABET",
      keyboardRow: 2,
    },
    G: {
      key: "G",
      code: "KeyG",
      shiftKey: true,
      finger: "leftIndex",
      shiftFinger: "right",
      type: "ALPHABET",
      keyboardRow: 3,
    },
    B: {
      key: "B",
      code: "KeyB",
      shiftKey: true,
      finger: "leftIndex",
      shiftFinger: "right",
      type: "ALPHABET",
      keyboardRow: 4,
    },
    "^": {
      key: "^",
      code: "Digit6",
      shiftKey: true,
      finger: "rightIndex",
      shiftFinger: "left",
      type: "digit-symbol",
      keyboardRow: 1,
    },
    Y: {
      key: "Y",
      code: "KeyY",
      shiftKey: true,
      finger: "rightIndex",
      shiftFinger: "left",
      type: "ALPHABET",
      keyboardRow: 2,
    },
    H: {
      key: "H",
      code: "KeyH",
      shiftKey: true,
      finger: "rightIndex",
      shiftFinger: "left",
      type: "ALPHABET",
      keyboardRow: 3,
    },
    N: {
      key: "N",
      code: "KeyN",
      shiftKey: true,
      finger: "rightIndex",
      shiftFinger: "left",
      type: "ALPHABET",
      keyboardRow: 4,
    },
    "&": {
      key: "&",
      code: "Digit7",
      shiftKey: true,
      finger: "rightIndex",
      shiftFinger: "left",
      type: "digit-symbol",
      keyboardRow: 1,
    },
    U: {
      key: "U",
      code: "KeyU",
      shiftKey: true,
      finger: "rightIndex",
      shiftFinger: "left",
      type: "ALPHABET",
      keyboardRow: 2,
    },
    J: {
      key: "J",
      code: "KeyJ",
      shiftKey: true,
      finger: "rightIndex",
      shiftFinger: "left",
      type: "ALPHABET",
      keyboardRow: 3,
    },
    M: {
      key: "M",
      code: "KeyM",
      shiftKey: true,
      finger: "rightIndex",
      shiftFinger: "left",
      type: "ALPHABET",
      keyboardRow: 4,
    },
    "*": {
      key: "*",
      code: "Digit8",
      shiftKey: true,
      finger: "rightMiddle",
      shiftFinger: "left",
      type: "digit-symbol",
      keyboardRow: 1,
    },
    I: {
      key: "I",
      code: "KeyI",
      shiftKey: true,
      finger: "rightMiddle",
      shiftFinger: "left",
      type: "ALPHABET",
      keyboardRow: 2,
    },
    K: {
      key: "K",
      code: "KeyK",
      shiftKey: true,
      finger: "rightMiddle",
      shiftFinger: "left",
      type: "ALPHABET",
      keyboardRow: 3,
    },
    "<": {
      key: "<",
      code: "Comma",
      shiftKey: true,
      finger: "rightMiddle",
      shiftFinger: "left",
      type: "basic-symbol",
      keyboardRow: 4,
    },
    "(": {
      key: "(",
      code: "Digit9",
      shiftKey: true,
      finger: "rightRing",
      shiftFinger: "left",
      type: "digit-symbol",
      keyboardRow: 1,
    },
    O: {
      key: "O",
      code: "KeyO",
      shiftKey: true,
      finger: "rightRing",
      shiftFinger: "left",
      type: "ALPHABET",
      keyboardRow: 2,
    },
    L: {
      key: "L",
      code: "KeyL",
      shiftKey: true,
      finger: "rightRing",
      shiftFinger: "left",
      type: "ALPHABET",
      keyboardRow: 3,
    },
    ">": {
      key: ">",
      code: "Period",
      shiftKey: true,
      finger: "rightRing",
      shiftFinger: "left",
      type: "basic-symbol",
      keyboardRow: 4,
    },
    ")": {
      key: ")",
      code: "Digit0",
      shiftKey: true,
      finger: "rightLittle",
      shiftFinger: "left",
      type: "digit-symbol",
      keyboardRow: 1,
    },
    P: {
      key: "P",
      code: "KeyP",
      shiftKey: true,
      finger: "rightLittle",
      shiftFinger: "left",
      type: "ALPHABET",
      keyboardRow: 2,
    },
    ":": {
      key: ":",
      code: "Semicolon",
      shiftKey: true,
      finger: "rightLittle",
      shiftFinger: "left",
      type: "basic-symbol",
      keyboardRow: 3,
    },
    "?": {
      key: "?",
      code: "Slash",
      shiftKey: true,
      finger: "rightLittle",
      shiftFinger: "left",
      type: "basic-symbol",
      keyboardRow: 4,
    },
    "`": {
      key: "`",
      code: "Backquote",
      shiftKey: false,
      finger: "leftLittle",
      shiftFinger: "",
      type: "advance-symbol",
      keyboardRow: 1,
    },
    "~": {
      key: "~",
      code: "Backquote",
      shiftKey: true,
      finger: "leftLittle",
      shiftFinger: "right",
      type: "advance-symbol",
      keyboardRow: 1,
    },
    "-": {
      key: "-",
      code: "Minus",
      shiftKey: false,
      finger: "rightLittle",
      shiftFinger: "",
      type: "advance-symbol",
      keyboardRow: 1,
    },
    "[": {
      key: "[",
      code: "BracketLeft",
      shiftKey: false,
      finger: "rightLittle",
      shiftFinger: "",
      type: "advance-symbol",
      keyboardRow: 2,
    },
    "'": {
      key: "'",
      code: "Quote",
      shiftKey: false,
      finger: "rightLittle",
      shiftFinger: "",
      type: "advance-symbol",
      keyboardRow: 3,
    },
    "=": {
      key: "=",
      code: "Equal",
      shiftKey: false,
      finger: "rightLittle",
      shiftFinger: "",
      type: "advance-symbol",
      keyboardRow: 1,
    },
    "]": {
      key: "]",
      code: "BracketRight",
      shiftKey: false,
      finger: "rightLittle",
      shiftFinger: "",
      type: "advance-symbol",
      keyboardRow: 2,
    },
    "\\": {
      key: "\\",
      code: "Backslash",
      shiftKey: false,
      finger: "rightLittle",
      shiftFinger: "",
      type: "advance-symbol",
      keyboardRow: 2,
    },
    _: {
      key: "_",
      code: "Minus",
      shiftKey: true,
      finger: "rightLittle",
      shiftFinger: "left",
      type: "advance-symbol",
      keyboardRow: 1,
    },
    "{": {
      key: "{",
      code: "BracketLeft",
      shiftKey: true,
      finger: "rightLittle",
      shiftFinger: "left",
      type: "advance-symbol",
      keyboardRow: 2,
    },
    '"': {
      key: '"',
      code: "Quote",
      shiftKey: true,
      finger: "rightLittle",
      shiftFinger: "left",
      type: "advance-symbol",
      keyboardRow: 3,
    },
    "+": {
      key: "+",
      code: "Equal",
      shiftKey: true,
      finger: "rightLittle",
      shiftFinger: "left",
      type: "advance-symbol",
      keyboardRow: 1,
    },
    "}": {
      key: "}",
      code: "BracketRight",
      shiftKey: true,
      finger: "rightLittle",
      shiftFinger: "left",
      type: "advance-symbol",
      keyboardRow: 2,
    },
    "|": {
      key: "|",
      code: "Backslash",
      shiftKey: true,
      finger: "rightLittle",
      shiftFinger: "left",
      type: "advance-symbol",
      keyboardRow: 2,
    },
  });

  constructor() {}

  /**
   * @param {string} key
   * @returns {string}
   */
  static getFinger(key) {
    return KeyData.data[key]?.finger ?? "";
  }
}

class LetterGenerator {
  /** @private @type {Record<string, boolean>} */ static availableLetters = {};

  /**
   * @private
   * @typedef {"leftLittle" | "leftRing" | "leftMiddle" | "leftIndex" | "rightIndex" | "rightMiddle" | "rightRing" | "rightLittle"} LetterGeneratorDataKey
   *
   * @typedef {Record<LetterGeneratorDataKey, string[]>} LetterGeneratorData
   * @type {LetterGeneratorData}
   */
  static data = {
    leftLittle: [],
    leftRing: [],
    leftMiddle: [],
    leftIndex: [],
    rightIndex: [],
    rightMiddle: [],
    rightRing: [],
    rightLittle: [],
  };

  /** @public @type {LetterGeneratorDataKey[]} */ static activeFingers = ["leftLittle", "leftRing", "leftMiddle", "leftIndex", "rightIndex", "rightMiddle", "rightRing", "rightLittle"];

  constructor() {
    for (let key in KeyData.data) {
      LetterGenerator.availableLetters[key] = true;
      LetterGenerator.data[KeyData.data[key].finger].push(key);
    }
  }

  /**
   * @returns {Readonly<LetterGeneratorData>}
   * @public
   */
  getAllDate() {
    return this.cloneReadonlyObject(LetterGenerator.data);
  }

  /**
   * @param {LetterGeneratorDataKey} dataKey
   * @returns {readonly string[]}
   * @public
   */
  getOneFingerDate(dataKey) {
    return this.cloneReadonlyObject(LetterGenerator.data[dataKey]);
  }

  /**
   * @param {Record<string, boolean>} newAvailableLetters
   * @returns {void}
   * @public
   */
  updateData(newAvailableLetters) {
    for (let key in newAvailableLetters) {
      LetterGenerator.availableLetters[key] = newAvailableLetters[key];
    }
    for (let key in LetterGenerator.data) {
      LetterGenerator.data[key] = [];
    }
    for (let key in KeyData.data) {
      if (LetterGenerator.availableLetters[key]) {
        const finger = KeyData.data[key].finger;
        LetterGenerator.data[finger].push(key);
      }
    }

    LetterGenerator.activeFingers = [];
    for (let key in LetterGenerator.data) {
      if (LetterGenerator.data[key].length) {
        const typedKey = /** @type {LetterGeneratorDataKey} */ (/** @type {unknown} */ key);
        LetterGenerator.activeFingers.push(typedKey);
      }
    }
  }

  /**
   * @param {number} numberOfLetters
   * @returns {{ finger: LetterGeneratorDataKey; letter: string }[]}
   * @public
   */
  generateRandomLetter(numberOfLetters) {
    const letters = [];
    for (let i = 0; i < numberOfLetters; i++) {
      letters.push(LetterGenerator.randomLetter());
    }
    return letters;
  }

  /**
   * @private
   * @template T
   * @param {T} obj
   * @returns {T}
   */
  cloneObject(obj) {
    const objClone = JSON.parse(JSON.stringify(obj));
    return objClone;
  }

  /**
   * @private
   * @template T
   * @param {T} obj
   * @returns {Readonly<T>}
   */
  cloneReadonlyObject(obj) {
    const objClone = Object.freeze(this.cloneObject(obj));
    return objClone;
  }

  /**
   * @template T
   * @param {T[]} array
   * @returns {T}
   */
  static randomItemFromArray(array) {
    return array[Math.floor(Math.random() * array.length)];
  }

  /**
   * @private
   * @returns {LetterGeneratorDataKey}
   */
  static randomFinger() {
    return LetterGenerator.randomItemFromArray(LetterGenerator.activeFingers);
  }

  /**
   * @private
   * @returns {{ finger: LetterGeneratorDataKey; letter: string }}
   */
  static randomLetter() {
    const finger = LetterGenerator.randomFinger();
    const letter = LetterGenerator.randomItemFromArray(LetterGenerator.data[finger]);
    return { finger, letter };
  }
}

class NumericalSetting {
  /**
   * @private
   * @typedef {keyof NumericalSetting.data} NumericalSettingDataKey
   */
  static data = {
    kpm: 100,
    letterSpeed: 100,
    letterDivHeight: 100,
    perfectHeight: 300,
  };

  /**
   * @private
   * @type {{ [key in NumericalSettingDataKey]: { step: number; min: number; max: number } }}
   */
  static dataSetting = Object.freeze({
    kpm: { step: 5, min: 1, max: 1000 },
    letterSpeed: { step: 50, min: 50, max: 300 },
    letterDivHeight: { step: 50, min: 50, max: 300 },
    perfectHeight: { step: 100, min: 100, max: 500 },
  });

  /**
   * @private
   * @type {{ [key in NumericalSettingDataKey]: JQuery<HTMLElement> }}
   */
  // @ts-ignore
  static $inputs = {};

  constructor() {
    const setData = this.setData.bind(this);
    const handlePlusBtnClick = this.handlePlusBtnClick.bind(this);
    const handleMinusBtnClick = this.handleMinusBtnClick.bind(this);
    const getInputValue = this.getInputValue.bind(this);
    const perfectHeightSideEffect = this.perfectHeightSideEffect.bind(this);

    for (let dataKey in NumericalSetting.data) {
      /** @type {NumericalSettingDataKey} */
      const typedDataKey = /** @type {NumericalSettingDataKey} */ (/** @type {unknown} */ (dataKey));
      const $container = $(`.numerical-setting-container[data-binding=${dataKey}]`);
      $container.find("button[action=increase]").on("click", function () {
        handlePlusBtnClick(typedDataKey);
      });
      $container.find("button[action=decrease]").on("click", function () {
        handleMinusBtnClick(typedDataKey);
      });

      NumericalSetting.$inputs[dataKey] = $container.find("input");
      NumericalSetting.$inputs[dataKey].val(NumericalSetting.data[dataKey].toString());

      if (typedDataKey === "perfectHeight") {
        perfectHeightSideEffect();
      }

      const { step, min, max } = NumericalSetting.dataSetting[dataKey];
      NumericalSetting.$inputs[dataKey].attr("min", min.toString());
      NumericalSetting.$inputs[dataKey].attr("max", max.toString());
      NumericalSetting.$inputs[dataKey].attr("step", step.toString());
      NumericalSetting.$inputs[dataKey].on("change", function () {
        const inputValue = NumericalSetting.$inputs[dataKey].val();
        const newNumber = getInputValue(inputValue);
        setData(typedDataKey, newNumber);
      });
    }
  }

  /**
   * @param {NumericalSettingDataKey} dataKey
   * @returns {number}
   * @public
   */
  getData(dataKey) {
    return NumericalSetting.data[dataKey];
  }

  /**
   * @param {NumericalSettingDataKey} dataKey
   * @param {number} newNumber
   * @returns {void}
   * @public
   */
  setData(dataKey, newNumber) {
    NumericalSetting.data[dataKey] = this.validateMinMax(dataKey, newNumber);
    NumericalSetting.$inputs[dataKey].val(NumericalSetting.data[dataKey].toString());

    if (dataKey === "perfectHeight") {
      this.perfectHeightSideEffect();
    }
  }

  /**
   * @param {NumericalSettingDataKey[]} dataKeys
   * @returns {void}
   * @public
   */
  enableInputs(dataKeys) {
    for (let dataKey of dataKeys) {
      NumericalSetting.$inputs[dataKey].prop("disabled", false);
      $(`.numerical-setting-container[data-binding=${dataKey}] button`).prop("disabled", false);
    }
  }

  /**
   * @param {NumericalSettingDataKey[]} dataKeys
   * @returns {void}
   * @public
   */
  disableInputs(dataKeys) {
    for (let dataKey of dataKeys) {
      NumericalSetting.$inputs[dataKey].prop("disabled", true);
      $(`.numerical-setting-container[data-binding=${dataKey}] button`).prop("disabled", true);
    }
  }

  /**
   * @private
   * @returns {void}
   */
  perfectHeightSideEffect() {
    $("#perfect-line").css("height", `${NumericalSetting.data.perfectHeight}px`);
  }

  /**
   * @private
   * @param {any} inputValue
   * @returns {number}
   */
  getInputValue(inputValue) {
    if (typeof inputValue === "number") {
      return inputValue;
    } else if (typeof inputValue === "string") {
      const result = parseInt(inputValue);
      if (isNaN(result)) {
        return 0;
      } else {
        return result;
      }
    }
    return 0;
  }

  /**
   * @private
   * @param {NumericalSettingDataKey} dataKey
   * @param {number} newNumber
   * @returns {number}
   */
  validateMinMax(dataKey, newNumber) {
    const { min, max } = NumericalSetting.dataSetting[dataKey];
    if (newNumber < min) {
      return min;
    } else if (newNumber > max) {
      return max;
    } else {
      return newNumber;
    }
  }

  /**
   * @private
   * @param {NumericalSettingDataKey} dataKey
   * @returns {void}
   */
  handlePlusBtnClick(dataKey) {
    const newNumber = NumericalSetting.data[dataKey] + NumericalSetting.dataSetting[dataKey].step;
    this.setData(dataKey, newNumber);
  }

  /**
   * @private
   * @param {NumericalSettingDataKey} dataKey
   * @returns {void}
   */
  handleMinusBtnClick(dataKey) {
    const newNumber = NumericalSetting.data[dataKey] - NumericalSetting.dataSetting[dataKey].step;
    this.setData(dataKey, newNumber);
  }
}

class StatisticsTable {
  /**
   * @private
   * @typedef {keyof StatisticsTable.data} StatisticsTableDataKey
   */
  static data = {
    perfectCount: 0,
    goodCount: 0,
    missCount: 0,
    comboCount: 0,
    maxComboCount: 0,
  };

  /** @type {{ [key in StatisticsTableDataKey]: JQuery<HTMLElement> }} */
  // @ts-ignore
  static $tableCell = {};

  constructor() {
    for (let dataKey in StatisticsTable.data) {
      /** @type {StatisticsTableDataKey} */
      const typedDataKey = /** @type {StatisticsTableDataKey} */ (/** @type {unknown} */ (dataKey));
      StatisticsTable.$tableCell[typedDataKey] = $(`#game-statistics-container tbody tr td[data-binding=${dataKey}]`);
      StatisticsTable.$tableCell[typedDataKey].text(StatisticsTable.data[dataKey].toString());
    }
  }

  /**
   * @param {StatisticsTableDataKey} dataKey
   * @returns {number}
   * @public
   */
  getData(dataKey) {
    return StatisticsTable.data[dataKey];
  }

  /**
   * @param {StatisticsTableDataKey} dataKey
   * @returns {void}
   * @public
   */
  addData(dataKey) {
    const newNumber = StatisticsTable.data[dataKey] + 1;
    this.setData(dataKey, newNumber);
  }

  /**
   * @param {StatisticsTableDataKey} dataKey
   * @returns {void}
   * @public
   */
  resetData(dataKey) {
    this.setData(dataKey, 0);
  }

  /**
   * @private
   * @returns {void}
   */
  sideEffectForSettingCombo() {
    if (StatisticsTable.data.comboCount > StatisticsTable.data.maxComboCount) {
      this.setData("maxComboCount", StatisticsTable.data.comboCount);
    }
  }

  /**
   * @private
   * @param {StatisticsTableDataKey} dataKey
   * @param {number} newNumber
   * @returns {void}
   */
  setData(dataKey, newNumber) {
    StatisticsTable.data[dataKey] = newNumber;
    StatisticsTable.$tableCell[dataKey].text(StatisticsTable.data[dataKey].toString());

    if (dataKey === "comboCount") {
      this.sideEffectForSettingCombo();
    }
  }
}

class CharacterSet {
  /**
   * @private
   * @typedef {keyof CharacterSet.characterSetSetting} CharacterSetSettingKey
   */
  static characterSetSetting = {
    alphabet: true,
    ALPHABET: true,
    digit: true,
    symbol: true,
    basicSymbol: true,
    digitSymbol: true,
    advanceSymbol: true,
  };

  /** @type {{ [key in CharacterSetSettingKey]: JQuery<HTMLElement> }} */
  // @ts-ignore
  static $characterSetCheckboxes = {};

  /**
   * @private
   * @typedef {keyof CharacterSet.fingerSetSetting} FingerSetSettingKey
   */
  static fingerSetSetting = {
    leftLittle: true,
    leftRing: true,
    leftMiddle: true,
    leftIndex: true,
    rightIndex: true,
    rightMiddle: true,
    rightRing: true,
    rightLittle: true,
  };

  /** @type {{ [key in FingerSetSettingKey]: JQuery<HTMLElement> }} */
  // @ts-ignore
  static $fingerSetCheckboxes = {};

  /**
   * @private
   * @typedef {keyof CharacterSet.keyboardRowSetSetting} KeyboardRowSetSettingKey
   */
  static keyboardRowSetSetting = {
    keyboardRow_1: true,
    keyboardRow_2: true,
    keyboardRow_3: true,
    keyboardRow_4: true,
  };

  /** @type {{ [key in KeyboardRowSetSettingKey]: JQuery<HTMLElement> }} */
  // @ts-ignore
  static $keyboardRowSetCheckboxes = {};

  /** @type {Record<string, JQuery<HTMLElement>>} */
  static $keys = {};

  /**
   * @private
   * @type {LetterGenerator}
   */
  letterGenerator;

  /** @param {LetterGenerator} letterGenerator */
  constructor(letterGenerator) {
    this.letterGenerator = letterGenerator;

    const toggleCharacterSetSetting = this.toggleCharacterSetSetting.bind(this);
    const toggleFingerSetSetting = this.toggleFingerSetSetting.bind(this);
    const toggleKeyboardRowSetSetting = this.toggleKeyboardRowSetSetting.bind(this);

    for (let dataKey in CharacterSet.characterSetSetting) {
      /** @type {CharacterSetSettingKey} */
      const typedDataKey = /** @type {CharacterSetSettingKey} */ (/** @type {unknown} */ (dataKey));
      CharacterSet.$characterSetCheckboxes[typedDataKey] = $(`#character-set-ul div[data-binding=${typedDataKey}] input`);
      CharacterSet.$characterSetCheckboxes[typedDataKey].prop("checked", CharacterSet.characterSetSetting[typedDataKey]);
      CharacterSet.$characterSetCheckboxes[typedDataKey].on("change", function () {
        toggleCharacterSetSetting(typedDataKey);
      });
    }

    for (let dataKey in CharacterSet.fingerSetSetting) {
      /** @type {FingerSetSettingKey} */
      const typedDataKey = /** @type {FingerSetSettingKey} */ (/** @type {unknown} */ (dataKey));
      CharacterSet.$fingerSetCheckboxes[typedDataKey] = $(`#finger-set-ul div[data-binding=${typedDataKey}] input`);
      CharacterSet.$fingerSetCheckboxes[typedDataKey].prop("checked", CharacterSet.fingerSetSetting[typedDataKey]);
      CharacterSet.$fingerSetCheckboxes[typedDataKey].on("change", function () {
        toggleFingerSetSetting(typedDataKey);
      });
    }

    for (let dataKey in CharacterSet.keyboardRowSetSetting) {
      /** @type {FingerSetSettingKey} */
      const typedDataKey = /** @type {FingerSetSettingKey} */ (/** @type {unknown} */ (dataKey));
      CharacterSet.$keyboardRowSetCheckboxes[typedDataKey] = $(`#keyboard-row-set-ul div[data-binding=${typedDataKey}] input`);
      CharacterSet.$keyboardRowSetCheckboxes[typedDataKey].prop("checked", CharacterSet.keyboardRowSetSetting[typedDataKey]);
      CharacterSet.$keyboardRowSetCheckboxes[typedDataKey].on("change", function () {
        toggleKeyboardRowSetSetting(typedDataKey);
      });
    }

    $(".keyboard-base .key").each(function () {
      const $this = $(this);
      const key = $this.text();
      CharacterSet.$keys[key] = $this;
    });
  }

  /**
   * @param {CharacterSetSettingKey} dataKey
   * @returns {boolean}
   * @public
   */
  getCharacterSetSetting(dataKey) {
    return CharacterSet.characterSetSetting[dataKey];
  }

  /**
   * @private
   * @param {CharacterSetSettingKey} dataKey
   * @param {boolean} checked
   * @returns {void}
   */
  setCharacterSetSetting(dataKey, checked) {
    const allRelatedDataKeys = ["symbol", "basicSymbol", "digitSymbol", "advanceSymbol"];
    switch (dataKey) {
      case "symbol":
        for (let relatedDataKey of allRelatedDataKeys) {
          CharacterSet.characterSetSetting[relatedDataKey] = checked;
          CharacterSet.$characterSetCheckboxes[relatedDataKey].prop("checked", checked);
        }
        break;
      case "basicSymbol":
      case "digitSymbol":
      case "advanceSymbol":
        CharacterSet.characterSetSetting[dataKey] = checked;
        CharacterSet.$characterSetCheckboxes[dataKey].prop("checked", checked);

        if (CharacterSet.characterSetSetting["basicSymbol"] && CharacterSet.characterSetSetting["digitSymbol"] && CharacterSet.characterSetSetting["advance-symbol"]) {
          CharacterSet.characterSetSetting["symbol"] = true;
          CharacterSet.$characterSetCheckboxes["symbol"].prop("checked", true);
          CharacterSet.$characterSetCheckboxes["symbol"].prop("indeterminate", false);
        } else if (CharacterSet.characterSetSetting["basicSymbol"] || CharacterSet.characterSetSetting["digit-symbol"] || CharacterSet.characterSetSetting["advanceSymbol"]) {
          CharacterSet.characterSetSetting["symbol"] = true;
          CharacterSet.$characterSetCheckboxes["symbol"].prop("checked", true);
          CharacterSet.$characterSetCheckboxes["symbol"].prop("indeterminate", true);
        } else if (!CharacterSet.characterSetSetting["basicSymbol"] && !CharacterSet.characterSetSetting["digit-symbol"] && !CharacterSet.characterSetSetting["advanceSymbol"]) {
          CharacterSet.characterSetSetting["symbol"] = false;
          CharacterSet.$characterSetCheckboxes["symbol"].prop("checked", false);
          CharacterSet.$characterSetCheckboxes["symbol"].prop("indeterminate", false);
        }
        break;
      default:
        CharacterSet.characterSetSetting[dataKey] = checked;
        CharacterSet.$characterSetCheckboxes[dataKey].prop("checked", checked);
        break;
    }
    const newAvailableCharacters = this.generateAvailableCharacters();
    this.letterGenerator.updateData(newAvailableCharacters);
  }

  /**
   * @private
   * @param {CharacterSetSettingKey} dataKey
   * @returns {void}
   */
  toggleCharacterSetSetting(dataKey) {
    this.setCharacterSetSetting(dataKey, !CharacterSet.characterSetSetting[dataKey]);
  }

  /**
   * @param {FingerSetSettingKey} dataKey
   * @returns {boolean}
   * @public
   */
  getFingerSetSetting(dataKey) {
    return CharacterSet.fingerSetSetting[dataKey];
  }

  /**
   * @private
   * @param {FingerSetSettingKey} dataKey
   * @param {boolean} checked
   * @returns {void}
   */
  setFingerSetSetting(dataKey, checked) {
    CharacterSet.fingerSetSetting[dataKey] = checked;
    CharacterSet.$fingerSetCheckboxes[dataKey].prop("checked", checked);
    const newAvailableCharacters = this.generateAvailableCharacters();
    this.letterGenerator.updateData(newAvailableCharacters);
  }

  /**
   * @private
   * @param {FingerSetSettingKey} dataKey
   * @returns {void}
   */
  toggleFingerSetSetting(dataKey) {
    this.setFingerSetSetting(dataKey, !CharacterSet.fingerSetSetting[dataKey]);
  }

  /**
   * @param {KeyboardRowSetSettingKey} dataKey
   * @returns {boolean}
   * @public
   */
  getKeyboardRowSetSetting(dataKey) {
    return CharacterSet.keyboardRowSetSetting[dataKey];
  }

  /**
   * @private
   * @param {KeyboardRowSetSettingKey} dataKey
   * @param {boolean} checked
   * @returns {void}
   */
  setKeyboardRowSetSetting(dataKey, checked) {
    CharacterSet.keyboardRowSetSetting[dataKey] = checked;
    CharacterSet.$keyboardRowSetCheckboxes[dataKey].prop("checked", checked);
    const newAvailableCharacters = this.generateAvailableCharacters();
    this.letterGenerator.updateData(newAvailableCharacters);
  }

  /**
   * @private
   * @param {KeyboardRowSetSettingKey} dataKey
   * @returns {void}
   */
  toggleKeyboardRowSetSetting(dataKey) {
    this.setKeyboardRowSetSetting(dataKey, !CharacterSet.keyboardRowSetSetting[dataKey]);
  }

  /**
   * @private
   * @returns {Record<string, boolean>}
   */
  generateAvailableCharacters() {
    /** @type{Record<string, boolean>} */
    const newAvailableCharacters = {};
    for (let key in KeyData.data) {
      if (
        CharacterSet.characterSetSetting[KeyData.data[key].type] &&
        CharacterSet.fingerSetSetting[KeyData.data[key].finger] &&
        CharacterSet.keyboardRowSetSetting["keyboardRow_" + KeyData.data[key].keyboardRow]
      ) {
        newAvailableCharacters[key] = true;
        CharacterSet.$keys[key]?.removeClass("exclude");
      } else {
        newAvailableCharacters[key] = false;
        CharacterSet.$keys[key]?.addClass("exclude");
      }
    }
    return newAvailableCharacters;
  }
}

class Game {
  /** @private @type {NumericalSetting} */ numericalSetting;
  /** @private @type {StatisticsTable} */ statisticsTable;
  /** @private @type {LetterGenerator} */ letterGenerator;

  /** @private @type {number} */ static intervalId = 0;
  /** @private @type {number} */ static letterIdx = 0;
  /** @private @type {number} */ static levelCombo = 0;
  /** @private @type {number} */ static levelComboStep = 5;
  /** @private @type {number} */ static levelMissing = 0;
  /** @private @type {number} */ static levelMissingStep = 5;
  /** @private @type {string} */ static shiftKeyIsPressing = "";

  /**
   * @private
   * @typedef {keyof Game.switchSetting} GameSwitchSettingKey
   */
  static switchSetting = {
    checkLeftRightShift: true,
  };

  /** @type {JQuery<HTMLElement>} } */
  // @ts-ignore
  static $comboProgressBar = null;

  /** @type {JQuery<HTMLElement>} } */
  // @ts-ignore
  static $missingProgressBar = null;

  // @ts-ignore
  /** @type {{ [key in CharacterSetSettingKey]: JQuery<HTMLElement> }} */ static $switches = {};

  /**
   * @param {NumericalSetting} numericalSetting
   * @param {StatisticsTable} statisticsTable
   * @param {LetterGenerator} letterGenerator
   */
  constructor(numericalSetting, statisticsTable, letterGenerator) {
    this.numericalSetting = numericalSetting;
    this.statisticsTable = statisticsTable;
    this.letterGenerator = letterGenerator;

    const toggleSetting = this.toggleSetting.bind(this);

    for (let dataKey in Game.switchSetting) {
      /** @type {GameSwitchSettingKey} */
      const typedDataKey = /** @type {GameSwitchSettingKey} */ (/** @type {unknown} */ (dataKey));
      Game.$switches[typedDataKey] = $(`div[data-binding=${typedDataKey}] input`);
      Game.$switches[typedDataKey].prop("checked", Game.switchSetting[typedDataKey]);
      Game.$switches[typedDataKey].on("change", function () {
        toggleSetting(typedDataKey);
      });
    }
    Game.$comboProgressBar = $("#combo-progress-bar");
    Game.$missingProgressBar = $("#missing-progress-bar");
  }

  /**
   * @returns {number}
   * @public
   */
  static getIntervalId() {
    return Game.intervalId;
  }

  /**
   * @param {boolean} attachListener
   * @returns {void}
   * @public
   */
  startPractice(attachListener = true) {
    const increaseLevelMissing = this.increaseLevelMissing.bind(this);
    const resetLevelCombo = this.resetLevelCombo.bind(this);
    const resetLevelMissing = this.resetLevelMissing.bind(this);
    const restartPracticeWithDifferentKmp = this.restartPracticeWithDifferentKmp.bind(this);
    const statisticsTable = this.statisticsTable;

    const trackMap = {
      leftLittle: $("#left-little-track"),
      leftRing: $("#left-ring-track"),
      leftMiddle: $("#left-middle-track"),
      leftIndex: $("#left-index-track"),
      rightIndex: $("#right-index-track"),
      rightMiddle: $("#right-middle-track"),
      rightRing: $("#right-ring-track"),
      rightLittle: $("#right-little-track"),
    };
    const trackHeight = $("#track-container").height() ?? 0;

    const kpm = this.numericalSetting.getData("kpm");
    const letterSpeed = this.numericalSetting.getData("letterSpeed");
    const letterDivHeight = this.numericalSetting.getData("letterDivHeight");
    const perfectHeight = this.numericalSetting.getData("perfectHeight");

    const timeInterval = (1 / (kpm / 60)) * 1000;
    /** @type {[number, number]} */
    const perfectRange = [0, trackHeight - perfectHeight];

    Game.intervalId = window.setInterval(() => {
      const newLetter = this.generateNewLetterElement(letterDivHeight, Game.letterIdx++);

      if (newLetter) {
        const { finger, element } = newLetter;
        $(trackMap[finger]).append(element);
        $(element).animate({ top: trackHeight + letterDivHeight }, ((trackHeight + letterDivHeight) / letterSpeed) * 1000, "linear", function () {
          statisticsTable.addData("missCount");
          statisticsTable.resetData("comboCount");
          increaseLevelMissing();
          $(element).remove();
        });
      }

      if (Game.levelCombo >= Game.levelComboStep) {
        resetLevelCombo();
        resetLevelMissing();
        restartPracticeWithDifferentKmp(kpm + 1);
      }

      if (Game.levelMissing >= Game.levelMissingStep) {
        resetLevelCombo();
        resetLevelMissing();
        restartPracticeWithDifferentKmp(kpm - 1);
      }
    }, timeInterval);

    if (attachListener) {
      this.attachKeydownKeyupListener(trackMap, perfectRange);
    }

    this.toggleInputAndButtonWhenStartOrStop("start");
  }

  /**
   * @returns {void}
   * @public
   */
  stopPractice() {
    this.clearInterval();
    $(document).off("keydown.game");
    $(document).off("keyup.game");
    $(".letter").stop().remove();
    this.toggleInputAndButtonWhenStartOrStop("stop");
  }

  /**
   * @private
   * @param {GameSwitchSettingKey} dataKey
   * @returns {boolean}
   */
  getSwitchSetting(dataKey) {
    return Game.switchSetting[dataKey];
  }

  /**
   * @private
   * @param {GameSwitchSettingKey} dataKey
   * @param {boolean} checked
   * @returns {void}
   */
  setSwitchSetting(dataKey, checked) {
    Game.switchSetting[dataKey] = checked;
    Game.$switches[dataKey].prop("checked", checked);
  }

  /**
   * @private
   * @param {GameSwitchSettingKey} dataKey
   * @returns {void}
   */
  toggleSetting(dataKey) {
    this.setSwitchSetting(dataKey, !Game.switchSetting[dataKey]);
  }

  /**
   * @private
   * @param {string} type
   * @returns {void}
   */
  toggleInputAndButtonWhenStartOrStop(type) {
    const bool = type === "start" ? true : false;

    /** @type {NumericalSettingDataKey[]} */
    const settingArr = ["kpm", "letterSpeed", "letterDivHeight", "perfectHeight"];
    bool ? this.numericalSetting.disableInputs(settingArr) : this.numericalSetting.enableInputs(settingArr);
    $("#check-left-right-shift-setting-container input").prop("disabled", bool);
    $("#start-practice-btn").prop("disabled", bool);
    $("#stop-practice-btn").prop("disabled", !bool);
  }

  /**
   * @private
   * @param {{ [key in LetterGeneratorDataKey]: JQuery<HTMLElement> }} trackMap
   * @param {[number, number]} perfectRange
   */
  attachKeydownKeyupListener(trackMap, perfectRange) {
    const increaseLevelCombo = this.increaseLevelCombo.bind(this);
    const statisticsTable = this.statisticsTable;

    const checkLeftRightShift = this.getSwitchSetting("checkLeftRightShift");

    $(document).on("keydown.game", function (/** @type{JQuery.KeyDownEvent<Document, undefined, Document, Document>} */ e) {
      if (e.code === "ShiftLeft" && Game.shiftKeyIsPressing !== "left") {
        Game.shiftKeyIsPressing = "left";
      } else if (e.code === "ShiftRight" && Game.shiftKeyIsPressing !== "right") {
        Game.shiftKeyIsPressing = "right";
      }
    });

    $(document).on("keyup.game", function (/** @type{JQuery.KeyUpEvent<Document, undefined, Document, Document>} */ e) {
      if (e.code === "ShiftLeft" || e.code === "ShiftRight") {
        Game.shiftKeyIsPressing = "";
        return;
      }

      const finger = KeyData.getFinger(e.key);
      if (finger) {
        const track = trackMap[finger];
        const firstChild = $(track).children().first();
        if (e.key === $(firstChild).text()) {
          if (checkLeftRightShift) {
            if (KeyData.data[e.key].shiftFinger !== Game.shiftKeyIsPressing) {
              return;
            }
          }

          const top = parseInt($(firstChild).css("top").replace("px", ""));
          if (top >= perfectRange[0] && top <= perfectRange[1]) {
            statisticsTable.addData("perfectCount");
            statisticsTable.addData("comboCount");
            $(firstChild).stop().remove();
            increaseLevelCombo(2);
          } else {
            statisticsTable.addData("goodCount");
            statisticsTable.addData("comboCount");
            $(firstChild).stop().remove();
            increaseLevelCombo(1);
          }
        }
      }
    });
  }

  /**
   * @private
   * @returns {void}
   */
  clearInterval() {
    window.clearInterval(Game.getIntervalId());
    Game.intervalId = 0;
  }

  /**
   * @private
   * @param {number} kpm
   * @returns {void}
   */
  restartPracticeWithDifferentKmp(kpm) {
    this.clearInterval();
    this.numericalSetting.setData("kpm", kpm);
    this.startPractice(false);
  }

  /**
   * @private
   * @param {number} newValue
   * @returns {void}
   */
  setLevelCombo(newValue) {
    Game.levelCombo = newValue;
    Game.$comboProgressBar.css("width", `${(Game.levelCombo / Game.levelComboStep) * 100}%`);
  }

  /**
   * @private
   * @param {number} increment
   * @returns {void}
   */
  increaseLevelCombo(increment) {
    this.setLevelCombo(Game.levelCombo + increment);
    this.resetLevelMissing();
  }

  /**
   * @private
   * @returns {void}
   */
  resetLevelCombo() {
    this.setLevelCombo(0);
  }

  /**
   * @private
   * @param {number} newValue
   * @returns {void}
   */
  setLevelMissing(newValue) {
    Game.levelMissing = newValue;
    Game.$missingProgressBar.css("width", `${(Game.levelMissing / Game.levelMissingStep) * 100}%`);
  }

  /**
   * @private
   * @returns {void}
   */
  increaseLevelMissing() {
    this.setLevelMissing(Game.levelMissing + 1);
    this.resetLevelCombo();
  }

  /**
   * @private
   * @returns {void}
   */
  resetLevelMissing() {
    this.setLevelMissing(0);
  }

  /**
   * @private
   * @param {number} idx
   * @returns {number}
   */
  getZIndex(idx) {
    return 1000 - (idx % 1000);
  }

  /**
   * @private
   * @param {number} letterDivHeight
   * @param {number} idx
   * @returns {{ finger: LetterGeneratorDataKey; element: JQuery<HTMLElement> } | undefined}
   */
  generateNewLetterElement(letterDivHeight, idx) {
    const getZIndex = this.getZIndex.bind(this);

    const letterDivHeightStr = letterDivHeight.toString() + "px";
    const { finger, letter } = this.letterGenerator.generateRandomLetter(1)[0];

    if (!letter) {
      return undefined;
    }

    let element = $("<div class='letter'></div>")
      .css({ height: letterDivHeightStr, top: "-" + letterDivHeightStr, zIndex: getZIndex(idx) })
      .text(letter);

    return { finger, element };
  }
}

// $(document).ready
$(function () {
  // let intervalId = 0;

  const letterGenerator = new LetterGenerator();
  const characterSet = new CharacterSet(letterGenerator);
  const statisticsTable = new StatisticsTable();
  const numericalSetting = new NumericalSetting();
  const game = new Game(numericalSetting, statisticsTable, letterGenerator);

  $("#start-practice-btn").on("click", function () {
    if (Game.getIntervalId() === 0) {
      game.startPractice();
    }
  });

  $("#stop-practice-btn").on("click", function () {
    if (Game.getIntervalId() !== 0) {
      game.stopPractice();
    }
  });

  $(".keyboard-base .key").each(function () {
    const $this = $(this);
    const key = $this.text();
    const finger = KeyData.getFinger(key);
    if (finger) {
      $this.addClass(finger);
    }
  });
});

// #region for debugging

// let debugData = {};

// const lettersForEachFingerDebug = Object.freeze({
//   leftLittle: ["1", "q", "a", "z", "!", "Q", "A", "Z", "`", "~"],
//   leftRing: ["2", "w", "s", "x", "@", "W", "S", "X"],
//   leftMiddle: ["3", "e", "d", "c", "#", "E", "D", "C"],
//   leftIndex: ["4", "r", "f", "v", "5", "t", "g", "b", "$", "R", "F", "V", "%", "T", "G", "B"],
//   rightIndex: ["6", "y", "h", "n", "7", "u", "j", "m", "^", "Y", "H", "N", "&", "U", "J", "M"],
//   rightMiddle: ["8", "i", "k", ",", "*", "I", "K", "<"],
//   rightRing: ["9", "o", "l", ".", "(", "O", "L", ">"],
//   rightLittle: ["0", "p", ";", "/", ")", "P", ":", "?", "-", "[", "'", "=", "]", "\\", "_", "{", '"', "+", "}", "|"],
// });

// /**
//  *
//  * @param {string} key
//  * @returns {string}
//  */
// function generateFinger(key) {
//   const finger = Object.keys(lettersForEachFingerDebug).find((finger) => lettersForEachFingerDebug[finger].includes(key));
//   return finger ?? "no-data";
// }

// $(document).on("keyup", function (e) {
//   console.log(e.key);
//   console.log(e);
//   const obj = {
//     key: e.key,
//     code: e.code,
//     shiftKey: e.shiftKey,
//     finger: generateFinger(e.key),
//     shiftFinger: e.shiftKey ? (generateFinger(e.key).includes("left") ? "right" : "left") : "",
//   };
//   debugData[e.key] = obj;
// });

// let all = Object.values(KeyData.data);
// console.log(`all.length`, all.length);

// let alphabet = [];
// let ALPHABET = [];
// let digit = [];
// let symbol = [];

// for (let x of all) {
//     if (x.key.match(/[a-z]/)) {
//         alphabet.push(x);
//     } else if (x.key.match(/[A-Z]/)) {
//         ALPHABET.push(x);
//     } else if (x.key.match(/[0-9]/)) {
//         digit.push(x);
//     } else {
//         symbol.push(x);
//     }
// }

// console.log(`alphabet`, alphabet);
// console.log(`ALPHABET`, ALPHABET);
// console.log(`digit`, digit);
// console.log(`symbol`, symbol);

// console.log(`alphabet.length`, alphabet.length);
// console.log(`ALPHABET.length`, ALPHABET.length);
// console.log(`digit.length`, digit.length);
// console.log(`symbol.length`, symbol.length);
// console.log(`sum of length`, alphabet.length + ALPHABET.length + digit.length + symbol.length);

// function checkDigits() {
//     const digits = [];

//     for (let myKey in KeyData.data) {
//         if (KeyData.data[myKey].type === "digit") {
//             digits.push(KeyData.data[myKey]);
//         }
//     }

//     digits.sort((a, b) => parseInt(a.key) - parseInt(b.key));
//     console.log(
//         `checkDigits ~ digits.key`,
//         digits.map((x) => x.key)
//     );
//     console.log("check length", digits.length === 10);
//     console.log(
//         "check shift",
//         digits.every((x) => x.shiftKey === false && x.shiftFinger === "")
//     );
// }
// checkDigits();

// function checkAlphabet() {
//     const alphabet = [];

//     for (let myKey in KeyData.data) {
//         if (KeyData.data[myKey].type === "alphabet") {
//             alphabet.push(KeyData.data[myKey]);
//         }
//     }

//     alphabet.sort((a, b) => a.key.localeCompare(b.key));
//     console.log(
//         `checkAlphabet ~ alphabet.key`,
//         alphabet.map((x) => x.key)
//     );
//     console.log("check length", alphabet.length === 26);
//     console.log(
//         "check shift",
//         alphabet.every((x) => x.shiftKey === false && x.shiftFinger === "")
//     );
// }
// checkAlphabet();

// function checkALPHABET() {
//     const ALPHABET = [];

//     for (let myKey in KeyData.data) {
//         if (KeyData.data[myKey].type === "ALPHABET") {
//             ALPHABET.push(KeyData.data[myKey]);
//         }
//     }

//     ALPHABET.sort((a, b) => a.key.localeCompare(b.key));
//     console.log(
//         `checkALPHABET ~ ALPHABET.key`,
//         ALPHABET.map((x) => x.key)
//     );
//     console.log("check length", ALPHABET.length === 26);
//     console.log(
//         "check shift",
//         ALPHABET.every((x) => (x.shiftKey === true && x.shiftFinger === "left") || "right")
//     );
// }
// checkALPHABET();

// #endregion
